<?xml version="1.0" encoding="UTF-8"?>

<mule
	xmlns:att-mule-applicationlogger="http://www.mulesoft.org/schema/mule/att-mule-applicationlogger"
	xmlns:validation="http://www.mulesoft.org/schema/mule/validation"
	xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/validation http://www.mulesoft.org/schema/mule/validation/current/mule-validation.xsd
http://www.mulesoft.org/schema/mule/att-mule-applicationlogger http://www.mulesoft.org/schema/mule/att-mule-applicationlogger/current/mule-att-mule-applicationlogger.xsd">
	
	<sub-flow name="get-product-current-bill-sub-flow"
		doc:id="0a100eb8-dc1b-45a8-979f-50035f2285fc">
		<att-mule-applicationlogger:log-message
			doc:name="log-start" doc:id="94b9b6c6-9f2d-445f-b794-7daddcb9ca86"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="Start of flow get-product-current-bill-sub-flow"
			method="#[vars.logHeaders.method]" reqHeaders="#[attributes.headers]"
			uri="#[vars.logHeaders.uri]"
			reqPayload='#[write({"productId" : attributes.uriParams.productId,"ban" :attributes.uriParams.ban},"application/json") as String]' />
		<ee:transform doc:name="set headers">
			<ee:variables>
				<ee:set-variable variableName="productId">attributes.uriParams.'productId'
				</ee:set-variable>
				<ee:set-variable variableName="ban">attributes.uriParams.'ban'
				</ee:set-variable>
			</ee:variables>
		</ee:transform>
		<http:request method="GET"
			doc:name="payment system api nextSubscriptionCharges"
			doc:id="c0ce3afc-3292-45ec-b0e0-1bec03cefb7d"
			config-ref="HTTPS_Payment_SystemAPI_Request_config"
			path="${secure::paymentSystemAPI.http.nextSubscriptionChargesPath}">
			<http:headers><![CDATA[#[output application/java
---
{
	"client_secret" : "${secure::paymentSystemAPI.http.clientSecret}",
	"client_id" : "${secure::paymentSystemAPI.http.clientId}"
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"ban" : vars.ban
}]]]></http:uri-params>
		</http:request>
		<att-mule-applicationlogger:log-message
			doc:name="log-end" doc:id="301151b1-132d-43a5-bbbd-a8bcfff03df8"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="End of flow get-product-current-bill-sub-flow"
			method="#[vars.logHeaders.method]" uri="#[vars.logHeaders.uri]" />
	</sub-flow>
	<sub-flow name="get-product-bill-pdf-sub-flow"
		doc:id="c8647c67-7d55-4a48-be09-57a311c6353f">
		<att-mule-applicationlogger:log-message
			doc:name="log-start" doc:id="76e3ee4b-1c34-4a70-9f90-a847df422c48"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="Start of flow get-product-bill-pdf-sub-flow"
			method="#[vars.logHeaders.method]" reqHeaders="#[attributes.headers]"
			uri="#[vars.logHeaders.uri]"
			reqPayload='#[write({"productId" : attributes.uriParams.productId,"ban" :attributes.uriParams.ban},"application/json") as String]' />
		<ee:transform doc:name="set headers">
			<ee:variables>
				<ee:set-variable variableName="productId">attributes.uriParams.'productId'
				</ee:set-variable>
				<ee:set-variable variableName="statementId">attributes.uriParams.'statementId'
				</ee:set-variable>
			</ee:variables>
		</ee:transform>
		<http:request method="GET" doc:name="billing api getpdf"
			doc:id="6477fa51-4862-4cd0-8bb9-2c2c9aa9e50e"
			config-ref="HTTPS_Billing_SystemAPI_Request_config"
			path="${secure::billingSystemAPI.http.billPdfPath}">
			<http:headers><![CDATA[#[output application/java
---
{
	"client_secret" : "${secure::billingSystemAPI.http.clientSecret}",
	"client_id" : "${secure::billingSystemAPI.http.clientId}"
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"statementId" : vars.statementId
}]]]></http:uri-params>
		</http:request>
		<att-mule-applicationlogger:log-message
			doc:name="log-end" doc:id="303866cd-3e3c-42fb-8709-ae0f6e0eed40"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="End of flow get-product-bill-pdf-sub-flow"
			method="#[vars.logHeaders.method]" uri="#[vars.logHeaders.uri]" />
	</sub-flow>
	<sub-flow name="get-product-bill-details-sub-flow"
		doc:id="54461f16-fef8-4086-a342-be13212cb221">
		<att-mule-applicationlogger:log-message
			doc:name="log-start" doc:id="9a52e068-27eb-4c50-8996-49766038bae3"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="Start of flow get-product-bill-details-sub-flow"
			method="#[vars.logHeaders.method]" reqHeaders="#[attributes.headers]"
			uri="#[vars.logHeaders.uri]"
			reqPayload='#[write({"productId" : attributes.uriParams.productId,"ban" :attributes.uriParams.ban},"application/json") as String]' />
		<ee:transform doc:name="set headers">
			<ee:variables>
				<ee:set-variable variableName="productId">attributes.uriParams.'productId'
				</ee:set-variable>
				<ee:set-variable variableName="statementId">attributes.uriParams.'statementId'
				</ee:set-variable>
			</ee:variables>
		</ee:transform>
		<http:request method="GET" doc:name="billing api getbilldetails"
			doc:id="450ed45e-ba51-475f-836d-37e9de2087ec"
			config-ref="HTTPS_Billing_SystemAPI_Request_config"
			path="${secure::billingSystemAPI.http.billDetailsPath}">
			<http:headers><![CDATA[#[output application/java
---
{
	"client_secret" : "${secure::billingSystemAPI.http.clientSecret}",
	"client_id" : "${secure::billingSystemAPI.http.clientId}"
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"statementId" : vars.statementId
}]]]></http:uri-params>
		</http:request>
		<att-mule-applicationlogger:log-message
			doc:name="log-end" doc:id="8556ef2b-d77e-488e-a043-fe999ba9e7ca"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="End of flow get-product-bill-details-sub-flow"
			method="#[vars.logHeaders.method]" uri="#[vars.logHeaders.uri]" />
	</sub-flow>
	<sub-flow name="retrieve-bill-summary-details-sub-flow"
		doc:id="4e914eed-8508-4a82-90ff-26f2d2c5adeb">
		<att-mule-applicationlogger:log-message
			doc:name="log-start" doc:id="361b29f4-1e03-4f80-89aa-05e22096f044"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="Start of flow retrieve-bill-summary-details-sub-flow"
			method="#[vars.logHeaders.method]" reqHeaders="#[attributes.headers]"
			uri="#[vars.logHeaders.uri]"
			reqPayload='#[write(payload,"application/json") as String]' />
		<scatter-gather doc:name="Scatter-Gather"
			doc:id="5e23eeb2-09ee-4a8d-8f19-a9944f6cd881">
			<route>
				<set-variable value='#[(payload filter ((item, index) -&gt; item.product == "Wireless"))[0]]' doc:name="to Wireless" doc:id="65f668c6-a2bd-4f55-bbca-cf462789883a" variableName="billHistoryRequest" />
				<flow-ref doc:name="billing-system-call-sub-flow"
					doc:id="44e47764-aaa6-4863-b519-8613afb05142"
					name="billing-system-call-sub-flow" />
			</route>
			<route>
				<set-variable value='#[(payload filter ((item, index) -&gt; item.product == "Wireline"))[0]]' doc:name="to Wireline" doc:id="0c85a98a-b9d2-418f-aae7-2c6f9c521648" variableName="billHistoryRequest" />
				<flow-ref doc:name="billing-system-call-sub-flow"
					doc:id="8e9c700a-a3f0-4f48-893d-0a72a8e03c6a"
					name="billing-system-call-sub-flow" />
			</route>
			<route>
				<set-variable value='#[(payload filter ((item, index) -&gt; item.product == "OTT"))[0]]' doc:name="to OTT" doc:id="1766c969-218e-43ad-b5f4-fe20d1ce7582" variableName="billHistoryRequest" />
				<flow-ref doc:name="ott-bill-history-sub-flow"
					doc:id="01f611fa-69c0-4b2b-85bd-586c7ff624bd"
					name="ott-bill-history-sub-flow" />
			</route>

		</scatter-gather>
		<ee:transform doc:name="format data"
			doc:id="0b3957db-66d0-4b31-94c2-3f0aa7476044">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json skipNullOn="everywhere"
---
{
		
	"Wireless" : if(not isEmpty(payload[0].payload)) (payload[0].payload) else null,
	"Wireline" : if(not isEmpty(payload[1].payload)) (payload[1].payload) else null,
	"OTT" : if(not isEmpty(payload[2].payload)) (payload[2].payload) else null
	
}]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<att-mule-applicationlogger:log-message
			doc:name="log-end" doc:id="bf71151d-f996-4aff-b1af-a7fcb7117f40"
			config-ref="ATT_Mule_Application_Logger_Config"
			message="End of flow retrieve-bill-summary-details-sub-flow"
			method="#[vars.logHeaders.method]" uri="#[vars.logHeaders.uri]" />
	</sub-flow>
	<sub-flow name="billing-system-call-sub-flow"
		doc:id="6916a680-1d12-4bb1-a4fa-732b471c0a2d">
		<choice doc:name="Choice" doc:id="b0bd216e-086b-48c5-a1a8-7db4a9491ebd">
			<when expression="#[not isEmpty(vars.billHistoryRequest)]">
				<set-variable value="#[vars.billHistoryRequest.ban]" doc:name="ban" doc:id="258b2144-f0ce-4822-8d4b-513f2f6074b0" variableName="ban" />
				<set-variable value="#[if(vars.billHistoryRequest.product == 'Wireline') 'ENBLR'
else 'TLG']" doc:name="billerId" doc:id="e410f9c6-3c41-4707-b934-ca1f8d36067e" variableName="billerId" />
				<http:request method="GET" doc:name="billing history" doc:id="03b2c23c-905e-40eb-be21-42d822c7be6d" config-ref="HTTPS_Billing_SystemAPI_Request_config" path="${secure::billingSystemAPI.http.billCycleHistoryPath}">
			<http:headers><![CDATA[#[output application/java
---
{
	"client_secret" : "${secure::billingSystemAPI.http.clientSecret}",
	"client_id" : "${secure::billingSystemAPI.http.clientId}"
}]]]></http:headers>
			<http:uri-params><![CDATA[#[output application/java
---
{
	"ban" : vars.ban,
	"billerId" : vars.billerId
}]]]></http:uri-params>
		</http:request>
				<ee:transform doc:name="filter records" doc:id="8be35167-a60e-4f12-81cf-c40dfcbc1ab9">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
type USDateType = Date { format: "MM/dd/yyyy" }
type InternationalDateType = Date { format: "yyyy-MM-dd" }
var requestedStartDate= vars.billHistoryRequest.startDate as InternationalDateType default ""
var requestedEndDate = vars.billHistoryRequest.endDate as InternationalDateType default ""
var billHistoryData = payload.content.billHistoryData
var defaultSizeofBillHistory = 5
---
if(isEmpty(requestedStartDate) or isEmpty(requestedEndDate))
	if(sizeOf(billHistoryData) > defaultSizeofBillHistory)
		billHistoryData[0 to 4]
	else
		billHistoryData
else if(not isEmpty(billHistoryData))
	(billHistoryData filter ((item, index) -> requestedStartDate >= item.cycleStartDate as USDateType and requestedEndDate <= item.cycleEndDate as USDateType)
	orderBy ((item, index) -> item.cycleStartDate as USDateType))[-1 to 0]
else
	payload]]></ee:set-payload>
			</ee:message>
		</ee:transform>
			</when>
			<otherwise>
				<flow-ref doc:name="set-null-array-payload" doc:id="34d9e2f8-5550-4bac-a9c4-61f94e663062" name="set-null-array-payload" />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="ott-bill-history-sub-flow"
		doc:id="c97ba4ca-b488-427a-9c11-6c080aedec4b">
		<choice doc:name="Choice"
			doc:id="50bed855-63e8-498d-bdd9-e5f6f2878339">
			<when expression="#[not isEmpty(vars.billHistoryRequest)]">
				<set-variable value="#[vars.billHistoryRequest.ban]"
					doc:name="ban" doc:id="4649ce80-350a-47b0-9659-9010dd236eaf"
					variableName="ban" />
				<http:request method="POST"
					doc:name="payment system api getAccountHistory"
					doc:id="487e6d4c-4426-4d75-ab30-ee4f43dbbc3d"
					config-ref="HTTPS_Payment_SystemAPI_Request_config"
					path="${secure::paymentSystemAPI.http.accountHistoryPath}">
					<http:body><![CDATA[#[output application/json
---
{
	"endDate" : vars.endDate,
	"startDate" : vars.startDate
}]]]></http:body>
					<http:headers><![CDATA[#[output application/java
---
{
	"client_secret" : "${secure::billingSystemAPI.http.clientSecret}",
	"client_id" : "${secure::billingSystemAPI.http.clientId}"
}]]]></http:headers>
					<http:uri-params><![CDATA[#[output application/java
---
{
	"ban" : vars.ban
}]]]></http:uri-params>
				</http:request>
			</when>
			<otherwise>
				<flow-ref doc:name="set-null-array-payload"
					doc:id="34a1bc45-8a4a-4998-b309-c5c65ead6d3b"
					name="set-null-array-payload" />
			</otherwise>
		</choice>
	</sub-flow>

	
	<sub-flow name="set-null-array-payload"
		doc:id="447ca3dd-9ea3-41bc-b03d-26e749bdd459">
		<set-payload value="#[[]]"
			doc:name="set null array payload"
			doc:id="ebb3d259-0dcf-431f-b767-1983c3fe5302" />
	</sub-flow>
</mule>
